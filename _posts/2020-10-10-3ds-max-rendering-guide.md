---
layout: post
title:  "Руководство по использованию рендер-фермы на базе Microsoft Azure"
author: sergeype
tags: [ Azure, Batch, hpc, cad, 3dsmax ]
image: assets/users/sergeyperus/rendering-guide.png
featured: true
hidden: true
---

Целью данной статьи ставлю дать простое руководство для пользователей 3DS Max по рендерингу моделей на рендер ферме, созданной в Microsoft Azure

Процесс рендеринга выглядит как следующая последовательность:

1) Подготовка. Делается один раз для рабочего места  
2) Загрузка готовой модели в облачное хранилище  
3) Запуск рендеринга  
4) Скачивание результатов

Предполагается, что ферма уже создана и модель построена

## ПОДГОТОВКА

Необходимо установить [Azure Batch Explorer](https://azure.github.io/BatchExplorer/) и авторизоваться с помощью учетной записи, имеющей доступ к ферме. 
После этого можно начинать рендеринг готовой модели даже без установленного 3DS Max. Если же он установлен, можно скачать для него [плагин](https://github.com/Azure/azure-batch-rendering/tree/master/plugins/3ds-max/) и запускать рендеринг из 3ds Max клиента. По сути, плагин будет запускать различные меню того же Batch Explorer, поэтому все руководство будет посвящено работе с ним напрямую

## ЗАГРУЗКА МОДЕЛИ

Необходимо создать в облачном хранилище папки, в которые будут загружаться проекты и откуда скачивать результаты рендеринга. 
Открываем пункт "**Data**", затем "**+**" и выбираем "**Empty File Group**". Хочу заметить, что не допускается использование пробелов ни в названии каталогов, ни в названии заданий на рендеринг. Заменяйте их символом "**-**". Для удобства, назовите группу в соответствии со своим алиасом, например, "**ivanov_input**" для загрузки моделей, и вторую "**ivanov_results**" для результатов. Это полезно, если с этой же фермой работают и ваши коллеги. 


![Image](/assets/users/sergeyperus/new-filegroup.png)

Выбираем папку "**ivanov_input**" и по кнопке "**+**" справа от нее добавляем каталог с нашей моделью. Здесь отмечу, что могут быть проблемы, если папка с моделью содержит много вложенных папок с длинными русскими именами. После загрузки модели можно делать сколько угодно отрисовок, в том числе с разных камер/разных кадров если в сцене присутствует движение. Если вносите изменения в сцену - загрузите в папку измененные/добавленные файлы тем же способом или просто перетаскиванием из проводника.

## РЕНДЕРИНГ

Модель загружена. Открываем меню "**Gallery**", выбираем нужный шаблон. В моем случае это будет "**3ds Max**". Далее выбираем нужное действие. В моем случае это "**VRay or Arnold scene**". На выборе режима выбираем использование существующего пула "**Run job with existing pool**".

Далее необходимо выбрать пул из существующих, выбрав нужный мышкой, и заполнить остальные поля:
*     дать имя задаче, например "**object1-default-camera-shot1**". Имя не должно совпадать с другой задачей, поэтому делайте его уникальным  
*     выбрать версию **Max**. В моем случае "**2019**"  
*     Выбрать движок отрисовки - "**vray**" в моем случае  
*     В поле "**Input Data**" необходимо выбрать папку, куда на этапе загрузки положили модель - "**fgrp-ivanov-input**"  
*     Нажимая на синюю пиктограмму, выбираем сам "***.max**" файл сцены в папке и жмем "**Pick**"  
*     Следующие поля можно пока пропустить  
*     В поле "**Camera**" можно опционально указать нужную камеру, если их несколько. По-умолчанию будет использована первая в списке  
*     В поле "**Additional args**" можно указать параметры, которые нужно изменить по отношению к тем, что сохранены в сцене. Например, размеры отрисовки. Если оставить пустым - все параметры будут взяты из сцены  
*     "**Frame Start**" и "**Frame End**" по-умолчанию выставлены в "**1**". Если камера двигается и нужно отрисовать динамичную сцену - стоит указать первый и последний кадр. На выходе получим соответствующее количество картинок, которые можно объединить в видеоролик. Стоит отметить, что выбранный режим "**VRay or Arnold scene**" предполагает, что каждый кадр будет отрисовывать одна машина из пула. Если требуется отрисовать множество кадров параллельно, в том числе для разных моделей - в формуле масштабирования для пула задается максимальное количество машин, работающих параллельно.  
*     В поле "**Output**" выбираем каталог для выгрузки результата рендеринга. Там же будет и телеметрия, которую можно смотреть на предмет ошибок/недостающих файлов и плагинов. Выбираю "**ivanov_results**"

Нажимаем "**Run and close**". При наличии ошибок - проверьте, что в названии задачи нет пробелов между словами и само имя - уникально

## СТАТЬЯ НЕ ЗАВЕРШЕНА