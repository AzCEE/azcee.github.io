---
layout: post
title:  "Использование Azure для локальной инфраструктуры"
author: sergeype
tags: [ Azure, Automation, Arc, LogAnalytics, Updates, Monitoring ]
image: assets/users/sergeyperus/hybrid.png
featured: true
hidden: true
---

Итак, вы не используете облака, у вас все локально, ну максимум немного местного хостинга. 
Для Вас смысл использования публичных облако неочевиден. Цель этой статьи - показать, какие преимущества Вы и Ваша локальная инфраструктура могут получить от использования облака Microsoft Azure. Далее я пошагово буду показывать все этапы развертывания, давать ссылки на документацию и объяснять стоимость

Начну сразу с результатов:

1) Ваши сервисы генерируют большое количество информации, которая позволяет оценивать их работоспособность, безопасность да и просто разбираться что с ними происходит. Вы организовали централизованное хранение метрик и журналов событий операционных систем Windows и Linux в едином облачном хранилище. Теперь удалить их невозможно, даже обладая высшими правами. У Вас есть доступ ко всей накопленной информации для поиска определенных событий, построения отчетности и создания оповещений о критичных, на ваш взгляд, событиях. Кроме того, на основании этой информации Microsoft Azure поможет получить полезные знания о происходящем в инфраструктуре

![Image](/assets/users/sergeyperus/loganalytics.gif)

2) Вы в реальном времени можете видеть метрики конкретного сервера или группы серверов, вне зависимости от их нахождения.
На любую метрику можем установить оповещение. Например, на диске меньше 80% свободного места

![Image](/assets/users/sergeyperus/vmperformance.gif)

3) Анализируется взаимодействие приложений и серверов друг с другом и с внешним миром. Сформирована динамичная карта сервисов. На выбранный промежуток времени Вы видите состояние всех компонентов приложения и проблемы, найденные у них. Например, неуспешное соединение, высокая загрузка ресурсов, проблемы с сетью или взаимодействие с вредоносными внешними ресурсами.

![Image](/assets/users/sergeyperus/servicemap.gif)

4) Вы видите, что происходит с сетями со стороны приложений - не только наличие/отсутствие соединения, но и его качество - задержки/потери в каждом сегменте, а так же путь сигнала. Если используете Office 365 - то сможете мониторить и соединение с ним со своих конечных точек. 

![Image](/assets/users/sergeyperus/networkperformance.png)

5) Регулярно проводится проверка критичных компонентов (Active Directory и SQL сервера) на соответствие лучшим практикам Microsoft. 

![Image](/assets/users/sergeyperus/adsqlassessment.png)

6) Вы видите ситуацию с обновлениями - что уже установлено, а что только выпущено для Microsoft и Linux систем. Можете запланировать развертывание по группам серверов и критичности обновлений. Прописать pre- и post- скрипты. Отслеживать результат

![Image](/assets/users/sergeyperus/updatemanagement.gif)

7) Любые изменения в составе программного обеспечения, отдельных папок/файлов и веток реестра сразу видны администратору. Программная инвентаризация - дело нескольких секунд в любой момент

![Image](/assets/users/sergeyperus/inventory.gif)

8) Система защиты от угроз автоматически строит граф по каждому инциденту, показывая всех участников событий (компьютеры, учетные записи, задействованное ПО или скрипты), что существенно упрощает расследование

![Image](/assets/users/sergeyperus/atp.png)

8) Без каких-либо капитальных затрат события безопасности из всех используемых Вами систем анализируются на предмет предотвращения вторжений с помощью облачной SIEM. Настроены механизмы автоматизации для остановки потенциальных атак. Например, блокирование скомпрометированных учетных записей, создание тикета в поддержку. Каждый найденный инцидент собирает воедино всех участников (учетные записи/компьютеры/сети...) для упрощения анализа произошедшего и ликвидации последствий

![Image](/assets/users/sergeyperus/sentinel.gif)

Теперь пошагово рассмотрим развертывание всех этих систем. Я буду использовать [портал Azure](https://portal.azure.com/), но все эти действия можно выполнить и через PowerShell

# Этап первый: мониторинг

## Стоимость

Первые 5 ГБ собираемой и хранимой 30 дней информации каждый месяц - бесплатно. Далее - по тарифу 186 рублей за 1ГБ. Здесь и далее все цены я буду брать из [калькулятора Azure](https://azure.microsoft.com/en-us/pricing/calculator/). Подробнее про [ценообразование мониторинга ](https://docs.microsoft.com/ru-ru/azure/azure-monitor/platform/usage-estimated-costs)
До начала работы сервисы вы, скорей всего, не знаете - какой объем логов генерят сервера. Поэтому мы сразу ограничим ежедневный объем принимаемой информациию чтоб избежать лишних затрат. По мере использования сервисы Вы будете видеть объем данных и менять ограничение по своему усмотрению


## Реализация

1. Будем использовать сервис [Azure Monitor](https://docs.microsoft.com/en-us/azure/azure-monitor/overview).

 Создадим [Рабочую Область](https://docs.microsoft.com/ru-ru/azure/azure-monitor/learn/quick-create-workspace) в регионе West Europe, например. Она будет использована для хранения данных, все остальные сервисы будут опираться на нее.

![Image](/assets/users/sergeyperus/createlaworkspace.gif)

# ------------- ПРОДОЛЖЕНИЕ В РАЗРАБОТКЕ, СЛЕДИТЕ ЗА ОБНОВЛЕНИЯМИ -------------

<!-- 

2. Далее необходиму установить агентов на сервера, которые будем мониторить. 

Сразу отмечу, что подключение серверов к мониторингу не требует открытия каких-либо входящих портов наружу со стороны локальной инфраструктуры. При этом, для выполнения задач (оценка производительности сети в частности) требуется сделать исключения во внутренней сети. 

Развернуть и настроить агентов можно по этой [инструкции] (https://docs.microsoft.com/en-us/services-hub/health/mma-setup).











## Network Performance Monitor 
https://docs.microsoft.com/en-us/azure/azure-monitor/insights/network-performance-monitor


















-->